---
title: "Exploratory Data Project"
output:
  pdf_document: default
  html_document: default
date: '2019-12-11'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Both of my datasets involved New York City. My first dataset is about AirBNB data for New York City. This dataset, after I removed some extraneous variables, includes price, minimum nights, availability out of the year, and number of reviews, amongst other things. The second dataset involved New York City real estate data. This set includes tax class at time of sale, sale price, square footage, and zipcode, amongst others. I chose data sets about New York City becuase I am originally from there, and was interested to explore some data about my hometown. I found both of these data sets from the Kaggle database. I expected some associations between price points and some of the variables. For example, I expected AirBNBs in Manhattan to be the most expensive, for price to increase with squre footage, and the number of reviews to negatively correlate with availability. 

##Task 1: Tidying and Joining
```{r}
#data(package = .packages(all.available = TRUE))
library(ggplot2)
library(tidyr)
library(dplyr)
library(tidyverse)
nyc_rolling_sales<-read.csv("nyc-rolling-sales.csv")
AB_NYC_2019<-read.csv("AB_NYC_2019.csv")
new<-nyc_rolling_sales%>% pivot_wider(names_from = "BOROUGH", values_from = "NEIGHBORHOOD")
nyc_sales<-new%>%pivot_longer(c(21:25), names_to = "borough", values_to = "neighborhood", values_drop_na = TRUE)
wide<-AB_NYC_2019%>%pivot_wider(names_from = "neighbourhood", values_from = "neighbourhood_group")
BNB<-wide%>%pivot_longer(-c(1:15),names_to = "neighborhood", values_to = "neighborhood_group", values_drop_na = TRUE)

nyc_sales<-nyc_sales%>%mutate(neighborhood=gsub("-","",neighborhood),
                              neighborhood=gsub(" ","",neighborhood),
                              neighborhood=gsub("'","",neighborhood),
                              neighborhood=tolower(neighborhood))

BNB<-BNB%>%mutate(neighborhood=gsub("-","",neighborhood),
                              neighborhood=gsub(" ","",neighborhood),
                              neighborhood=gsub("'","",neighborhood),
                              neighborhood=tolower(neighborhood))

nyc_nbh<-nyc_sales%>%mutate(GROSS.SQUARE.FEET=as.numeric(as.character(GROSS.SQUARE.FEET)),LAND.SQUARE.FEET=as.numeric(as.character(LAND.SQUARE.FEET)))%>%select(-c(1:10))%>%group_by(neighborhood)%>%summarize_if(is.numeric,mean,na.rm=T)

BNB_nbh <- BNB%>%select(-c(1:7,11,15),neighborhood)%>%group_by(neighborhood) 

comb<- nyc_nbh %>% inner_join(BNB_nbh, by= "neighborhood")

glimpse(comb)
```
Both of my datasets were tidy so in order to make them unitidy, I employed the pivot_wider function. This led to individual variables having their own column, which is not tidy. To re-tidy, I used pivot_longer. 
When it came time to join both sets, I chose to use inner join because there are so many neighborhoods in New York City, the data would have become too massive and would not have added any value to the analysis. By selecting only for the neighborhoods both sets have in common, the data becomes managable and trends become easier to spot. 

##Task 2: Wrangling
```{r}
comb%>%filter(neighborhood=="chelsea")
comb%>%slice(1:5)
comb%>%arrange(price)
comb%>% arrange(desc(price))
comb%>%select(neighborhood,neighborhood_group) %>% distinct() %>% arrange(neighborhood_group)
comb%>% select(GROSS.SQUARE.FEET, price)
comb%>%mutate(ResUnits_avg=RESIDENTIAL.UNITS/TOTAL.UNITS)
comb%>%group_by(neighborhood_group) %>% summarize(meanp=mean(price,na.rm = T))
comb%>%group_by(neighborhood_group)%>% summarize (meanfoot=mean(GROSS.SQUARE.FEET, na.rm = T))
comb%>%group_by(neighborhood_group)%>% summarize (meanfoot1=mean(LAND.SQUARE.FEET, na.rm = T))
comb%>%group_by(neighborhood_group)%>% summarize (res=mean(RESIDENTIAL.UNITS, na.rm = T))
comb%>% group_by(neighborhood_group) %>% summarize(meanavail=mean(availability_365, na.rm = T))
comb%>% filter(neighborhood_group=="Staten Island")%>%group_by(neighborhood)%>% summarize(meanavail=mean(availability_365, na.rm = T)) %>% arrange(desc(meanavail))
comb%>% filter(neighborhood_group=="Manhattan")%>%group_by(neighborhood)%>% summarize(meanavail=mean(availability_365, na.rm = T)) %>% arrange((meanavail))
comb%>%group_by(neighborhood_group)%>% summarize(meanyr=mean(YEAR.BUILT, na.rm = T))
comb%>%group_by(neighborhood_group)%>% summarize(minyr=min(YEAR.BUILT, na.rm = T))
comb %>% group_by(price) %>% na.omit() %>%
 summarize(meanavail=mean(availability_365), meanfoot=mean(GROSS.SQUARE.FEET), review=mean(reviews_per_month)) %>% cor()
```
 When arranging each neighborhood by price, Astoria was the most expensive and Bedford Stuyvesant was least expensive. When grouping by borough, Manhattan was the most expensive and Bronx was least expensive on average, which is consistent with what I expected. Manhattan is also the biggest, while Staten Island is the smallest of the neighborhood groups. Bronx had the most residential units and Staten Island had the least, which I did not expect. I expected Manhattan to have to least residential units because I think there are more office buildings and business there proportional to the other neighborhood groups. 
When looking at AirBNB availability, Manhattan seemed the busiest, as the AirBNBs are available or open on fewer days out of the year, and Staten Island was the most available, so probably the least popular with AirBNB guests. Of the options in Staten Island, the AirBNBs in Richmondtown were available 300 out of 365 days of the year, making this the least popular neighborhood in all of New York City. Morningside Heights in Manhattan is the most popular destination for AirBNB guests, as it is only available 43 days of the year, and booked the rest of the time. 
When looking to see the average year each borough was developed, Manhattan and Bronx showed the 1600s. This probably meant there were some low values in the data set skewing the mean calculation. The minimum year for Bronx showed 493, and minimum year for Manhattan was 1378, which cannot be accurate and probably led to the incorrect mean. Even Brooklyn's minimum year was incorrect, showing 1492. Surprisingly, the correlation matrix did not show any particularly strong correlations. The strongest one was the correlation between price and mean square footage, which makes sense.  
 
## Task 3: Visualization
```{r}
library(ggplot2)

#Relationship between Commercial and Residential units by neighborhood group
ggplot(comb, aes(RESIDENTIAL.UNITS,COMMERCIAL.UNITS))+
geom_point(aes(color=neighborhood_group)) + xlim(c(0,5.5))+ ylim(c(0,1)) + ggtitle("Relationship Between Commercial and Residential Units")

#How many BNB in manhattan neighborhoods
Manhattan <- comb%>%filter(neighborhood_group=="Manhattan")
ggplot(Manhattan, aes(neighborhood))+
geom_bar(aes(fill=neighborhood))+
coord_flip()+
theme(legend.position="none") + ggtitle("Number of AirBNBs in Manhattan")

#How many BNB by neighborhood group
ggplot(comb, aes(neighborhood_group, fill=neighborhood_group),)+geom_bar(stat="count") +ggtitle("AirBnBs by Neighborhood Group") + theme(legend.position="none") + xlab("Neighborhood Group")

#Availability based on Neighborhood Group
ggplot(comb, aes(x = neighborhood_group, y = availability_365, fill=neighborhood_group))+
geom_bar(stat="summary",fun.y="mean")+
geom_errorbar(stat="summary") + ggtitle("AirBNB Availability Based on Neighborhood Group") +theme(legend.position="none") +xlab("Neighborhood Group") +ylab("Availability(days)")

#Most common price range for neighborhoods in Manhattan
ggplot(Manhattan, aes(x=price, fill=neighborhood)) +
 geom_density(alpha=.75)+ xlim(c(1,2000))+ ggtitle("Price Points for Manhattan AirBNBs")

#Most common price range for all of NYC
ggplot(comb, aes(x=price, fill=neighborhood_group)) +
 geom_density(alpha=.75)+ xlim(c(1,2000))+ ggtitle("Price Points for AirBNBs")
```

Graph 1: I wanted to see if there was a relationship between the number of commercial units and residential units in any one neighborhood group. Each individual point represents a neighborhood within each neighborhood group. I expected the neighborhoods in Manhattan to have more commercial than residential units because so much business is conducted in that part of the city. According to the results, there is no clear relationship between both variables. If anything can be extrapolated from this graph, there is a negative correlation between commercial and residential units in Bronx. 

Graph 2: When wrangling data, I saw Manhattan was the most popular AirBNB destination so I wanted to explore that neighborhood group more. I wanted to see which neighborhoods in Manhattan had the most AirBNBs. According to the results, Eastvillage has the most while Civic Center has the least. This may have to do with the overall proportion of homes in each of these neighborhoods (for ex, Civic Center may just be mostly a commercial neighborhood), but that would be interesting to explore. It would also have been nice to add a third dimension to the graph measuring how popular each neighborhood is with the "availibility_365" variable, but because this is a barplot and the availility variable is continuous, this was not possible.

Graph 3: This graph shows how many AirBNBs there are in each neighborhood group. It is interesting to see tha although Brooklyn has over double the amount of AirBNBs, people are still willing to pay higher prices and stay in Manhattan, because in terms of popularity Manhattan is slightly more likely to be booked than Brooklyn. This is shown on Graph 4.

Graph 4: Graph 4 shows how many days out of the year AirBNBs in each neighborhood group are available. As expected, Manhattan is the most popular, Brooklyn is a close second. These AirBNBs are booked out 2/3 of the year. It would be easy to find an AirBNB in Staten Island, though, seeing as how they are available almost 200 days out of 365. Standard error is low for all neighborhoods. 

Graph 5: This density plot shows the most common price points for AirBNBs in Manhattan. I chose this neighborhood group because I wanted to see how much people are paying for this most popular AirBNB destination. It seems most Manhattan neighborhoods fall within a similar pricepoint, with fancier areas like Tribeca and SoHo being outliers.

Graph 6: This density plot shows that all neighborhood groups in New York seem to have overlapping price points, with Manhattan's average being a little higher than the rest, as expected, and Brooklyn's being the second highest. As confirmed by the previous plot, Brooklyn has the greatest number of AirBNBs in the city. 

I only had 2 categorical variables, and "neighborhood" was quite expansive, making it difficult to come up with plots that showed interaction between three variables. 

##Task4: PCA
```{r}
comb1<-comb%>%select(-neighborhood)
comb_nums<-comb1%>%select_if(is.numeric)%>%scale
rownames(comb_nums)<-comb1$neighborhood_group
comb_pca<-princomp(na.omit(comb_nums), cor=TRUE, scores=TRUE)
names(comb_pca)
summary(comb_pca, loadings=T)
eigval<-comb_pca$sdev^2
varprop=round(eigval/sum(eigval),2) 
ggplot()+geom_bar(aes(y=varprop,x=1:13),stat="identity")+xlab("")+geom_path(aes(y=varprop,x=1:13))+
 geom_text(aes(x=1:13,y=varprop,label=round(varprop,2)),vjust=1,col="white",size=5)+
 scale_y_continuous(breaks=seq(0,.6,.2),labels = scales::percent)+
 scale_x_continuous(breaks=1:10)
round(cumsum(eigval)/sum(eigval),2) 
eigval
summary(comb_pca, loadings=T)
comb_pca$loadings[1:7,1:2]%>%as.data.frame%>%rownames_to_column%>%
ggplot()+geom_hline(aes(yintercept=0),lty=2)+
 geom_vline(aes(xintercept=0),lty=2)+ylab("PC2")+xlab("PC1")+
 geom_segment(aes(x=0,y=0,xend=Comp.1,yend=Comp.2),arrow=arrow(),col="red")+
 geom_label(aes(x=Comp.1*1.1,y=Comp.2*1.1,label=rowname))
ggplot()+geom_point(aes(comb_pca$scores[,1], comb_pca$scores[,2]))+xlab("PC1")+ylab("PC2")
```

The strongest correlations between variables are visualized on the first graph based on the spacing of the arrows. This is why "Land Square Feet" and "Gross Square Feet" are right on top of each other. The square footage also correlates with the tax class at the time of the sale of the land, which makes sense. Generally, larger plots of land are taxed at higher rates than smaller plots. Year built was not correlated with any of the other varaibles.
The second graph shows the association between PC1 and PC2, although there is not any distinct relationship between the two.No matter how far along the PC1 axis the data is, it is generally at the same height on PC2.  